<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这是木杉的个人博客"><title>JDK源码阅读-FileDescriptor | 木杉的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ec7ecb4616a008addeb60c9709230453";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">JDK源码阅读-FileDescriptor</h1><a id="logo" href="/.">木杉的博客</a><p class="description">要么精通，要么死</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">JDK源码阅读-FileDescriptor</h1><div class="post-meta">May 29, 2018<span> | </span><span class="category"><a href="/categories/Java/">Java</a><a href="/categories/Java/JDK源码阅读/">JDK源码阅读</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="2018/05/29/java/language/JDK源码阅读-FileDescriptor/" href="/2018/05/29/java/language/JDK源码阅读-FileDescriptor/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#FileDescriptor与文件描述符"><span class="toc-number">1.</span> <span class="toc-text">FileDescriptor与文件描述符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#标准输入，标准输出，标准错误输出"><span class="toc-number">2.</span> <span class="toc-text">标准输入，标准输出，标准错误输出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FileDescriptor关闭逻辑"><span class="toc-number">3.</span> <span class="toc-text">FileDescriptor关闭逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="post-content"><p>操作系统使用文件描述符来指代一个打开的文件，对文件的读写操作，都需要文件描述符作为参数。Java虽然在设计上使用了抽象程度更高的流来作为文件操作的模型，但是底层依然要使用文件描述符与操作系统交互，而Java世界里文件描述符的对应类就是FileDescriptor。</p>
<a id="more"></a>
<p>Java文件操作的三个类：<code>FileIntputStream</code>，<code>FileOutputStream</code>，<code>RandomAccessFile</code>，打开这些类的源码可以看到都有一个FileDescriptor成员变量。</p>
<p>注：本文使用的JDK版本为8。</p>
<h2 id="FileDescriptor与文件描述符"><a href="#FileDescriptor与文件描述符" class="headerlink" title="FileDescriptor与文件描述符"></a>FileDescriptor与文件描述符</h2><p>操作系统中的文件描述符本质上是一个非负整数，其中0,1,2固定为标准输入，标准输出，标准错误输出，程序接下来打开的文件使用当前进程中最小的可用的文件描述符号码，比如3。</p>
<p>文件描述符本身就是一个整数，所以FileDescriptor的核心职责就是保存这个数字：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDescriptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是文件描述符是无法在Java代码里设置的，因为FileDescriptor只有私有和无参的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    fd = -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">FileDescriptor</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.fd = fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那Java是在何时会设置FileDescriptor的fd字段呢？这要结合<code>FileIntputStream</code>，<code>FileOutputStream</code>，<code>RandomAccessFile</code>的代码来看了。</p>
<p>我们以<code>FileInputStream</code>为例，首先，<code>FileInputStream</code>有一个<code>FileDescriptor</code>成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileInputStream</span> <span class="keyword">extends</span> <span class="title">InputStream</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileDescriptor fd;</span><br></pre></td></tr></table></figure>
<p>在<code>FileInputStream</code>实例化时，会新建<code>FileDescriptor</code>实例，并使用<code>fd.attach(this)</code>关联<code>FileInputStream</code>实例与<code>FileDescriptor</code>实例，这是为了日后关闭文件描述符做准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileInputStream</span><span class="params">(File file)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">    String name = (file != <span class="keyword">null</span> ? file.getPath() : <span class="keyword">null</span>);</span><br><span class="line">    fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">    fd.attach(<span class="keyword">this</span>);</span><br><span class="line">    path = name;</span><br><span class="line">    open(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(String name)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">    open0(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">open0</span><span class="params">(String name)</span> <span class="keyword">throws</span> FileNotFoundException</span>;</span><br></pre></td></tr></table></figure>
<p>但是上面的代码也没有对<code>FileDescriptor#fd</code>进行赋值，实际上Java层面无法对他赋值，真正的逻辑是在<code>FileInputStream#open0</code>这个native方法中，这就要下载JDK的源码来看了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /jdk/src/share/native/java/io/FileInputStream.c</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileInputStream_open(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path) &#123;</span><br><span class="line">    fileOpen(env, <span class="keyword">this</span>, path, fis_fd, O_RDONLY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /jdk/src/solaris/native/java/io/io_util_md.c</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">fileOpen(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path, jfieldID fid, <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    WITH_PLATFORM_STRING(env, path, ps) &#123;</span><br><span class="line">        FD fd;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__linux__) || defined(_ALLBSD_SOURCE)</span></span><br><span class="line">        <span class="comment">/* Remove trailing slashes, since the kernel won't */</span></span><br><span class="line">        <span class="keyword">char</span> *p = (<span class="keyword">char</span> *)ps + <span class="built_in">strlen</span>(ps) - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ((p &gt; ps) &amp;&amp; (*p == <span class="string">'/'</span>))</span><br><span class="line">            *p-- = <span class="string">'\0'</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        fd = JVM_Open(ps, flags, <span class="number">0666</span>); <span class="comment">// 打开文件拿到文件描述符</span></span><br><span class="line">        <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            SET_FD(<span class="keyword">this</span>, fd, fid); <span class="comment">// 非负整数认为是正确的文件描述符，设置到fd字段</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            throwFileNotFoundException(env, path);  <span class="comment">// 负数认为是不正确文件描述符，抛出FileNotFoundException异常</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; END_PLATFORM_STRING(env, ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到JDK的JNI代码中，使用<code>JVM_Open</code>打开文件，得到文件描述符，而<code>JVM_Open</code>已经不是JDK的方法了，而是JVM提供的方法，所以我们需要在hotspot中寻找其实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /hotspot/src/share/vm/prims/jvm.cpp</span></span><br><span class="line">JVM_LEAF(jint, JVM_Open(<span class="keyword">const</span> <span class="keyword">char</span> *fname, jint flags, jint mode))</span><br><span class="line">  JVMWrapper2(<span class="string">"JVM_Open (%s)"</span>, fname);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//%note jvm_r6</span></span><br><span class="line">  <span class="keyword">int</span> result = os::open(fname, flags, mode);  <span class="comment">// 调用os::open打开文件</span></span><br><span class="line">  <span class="keyword">if</span> (result &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span>(errno) &#123;</span><br><span class="line">      <span class="keyword">case</span> EEXIST:</span><br><span class="line">        <span class="keyword">return</span> JVM_EEXIST;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">JVM_END</span><br><span class="line"></span><br><span class="line"><span class="comment">// /hotspot/src/os/linux/vm/os_linux.cpp</span></span><br><span class="line"><span class="keyword">int</span> os::open(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">int</span> oflag, <span class="keyword">int</span> mode) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(path) &gt; MAX_PATH - <span class="number">1</span>) &#123;</span><br><span class="line">    errno = ENAMETOOLONG;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">int</span> o_delete = (oflag &amp; O_DELETE);</span><br><span class="line">  oflag = oflag &amp; ~O_DELETE;</span><br><span class="line"></span><br><span class="line">  fd = ::open64(path, oflag, mode);  <span class="comment">// 调用open64打开文件</span></span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 问打开成功也可能是目录，这里还需要判断是否打开的是普通文件</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat64</span> <span class="title">buf64</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret = ::fstat64(fd, &amp;buf64);</span><br><span class="line">    <span class="keyword">int</span> st_mode = buf64.st_mode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((st_mode &amp; S_IFMT) == S_IFDIR) &#123;</span><br><span class="line">        errno = EISDIR;</span><br><span class="line">        ::close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ::close(fd);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FD_CLOEXEC</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> flags = ::fcntl(fd, F_GETFD);</span><br><span class="line">        <span class="keyword">if</span> (flags != <span class="number">-1</span>)</span><br><span class="line">            ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (o_delete != <span class="number">0</span>) &#123;</span><br><span class="line">    ::unlink(path);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到JVM最后使用<code>open64</code>这个方法打开文件，网上对于<code>open64</code>这个资料还是很少的，我找到的是<a href="https://www.unix.com/man-page/All/2/open64/" target="_blank" rel="noopener">man page for open64 (all section 2) - Unix &amp; Linux Commands</a>，从中可以看出，<code>open64</code>是为了在32位环境打开大文件的系统调用，但是不是标准的一部分。（这一部分不是很确定，因为没有明确的资料）</p>
<p>这里的open不是我们以前学C语言时打开文件用的fopen函数，fopen是C标准库里的函数，而open不是，open是POSIX规范中的函数，是不带缓冲的I/O，不带缓冲的I/O相关的函数还有read，write，lseek，close，不带缓冲指的是这些函数都调用内核中的一个系统调用，而C标准库为了减少系统调用，使用了缓存来减少read，write的内存调用。（参考《UNIX环境高级编程》）</p>
<p>通过上面的代码跟踪，我们知道了<code>FileInputStream#open</code>是使用open系统调用来打开文件，得到文件句柄，现在我们的问题要回到这个文件句柄是如何最终设置到<code>FileDescriptor#fd</code>，我们来看<code>/jdk/src/solaris/native/java/io/io_util_md.c:fileOpen</code>的关键代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fd = handleOpen(ps, flags, <span class="number">0666</span>);</span><br><span class="line"><span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    SET_FD(<span class="keyword">this</span>, fd, fid);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    throwFileNotFoundException(env, path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果文件描述符fd正确，通过<code>SET_FD</code>这个红设置到<code>fid</code>对应的成员变量上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET_FD(this, fd, fid) \</span></span><br><span class="line">    <span class="keyword">if</span> ((*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)) != <span class="literal">NULL</span>) \</span><br><span class="line">        (*env)-&gt;SetIntField(env, (*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)),IO_fd_fdID, (fd))</span><br></pre></td></tr></table></figure>
<p><code>SET_FD</code>宏比较简单，获取<code>FileInputStream</code>上的<code>fid</code>这个字段ID对应的字段，然后设置这个字段的<code>IO_fd_fdID</code>对应的字段（<code>FileDescriptor#fd</code>）为文件描述符。</p>
<p>那这个<code>fid</code>和<code>IO_fd_fdID</code>是哪里来的呢？在<code>/jdk/src/share/native/java/io/FileInputStream.c</code>的开头，可以看到这样的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jdk/src/share/native/java/io/FileInputStream.c</span></span><br><span class="line">jfieldID fis_fd; <span class="comment">/* id for jobject 'fd' in java.io.FileInputStream */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************</span></span><br><span class="line"><span class="comment"> * static methods to store field ID's in initializers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileInputStream_initIDs(JNIEnv *env, jclass fdClass) &#123;</span><br><span class="line">    fis_fd = (*env)-&gt;GetFieldID(env, fdClass, <span class="string">"fd"</span>, <span class="string">"Ljava/io/FileDescriptor;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Java_java_io_FileInputStream_initIDs</code>对应<code>FileInputStream</code>中static块调用的<code>initIDs</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileInputStream</span> <span class="keyword">extends</span> <span class="title">InputStream</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/* File Descriptor - handle to the open file */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileDescriptor fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        initIDs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">initIDs</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有<code>jdk/src/solaris/native/java/io/FileDescriptor_md.c</code>开头：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jdk/src/solaris/native/java/io/FileDescriptor_md.c</span></span><br><span class="line"><span class="comment">/* field id for jint 'fd' in java.io.FileDescriptor */</span></span><br><span class="line">jfieldID IO_fd_fdID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************</span></span><br><span class="line"><span class="comment"> * static methods to store field ID's in initializers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileDescriptor_initIDs(JNIEnv *env, jclass fdClass) &#123;</span><br><span class="line">    IO_fd_fdID = (*env)-&gt;GetFieldID(env, fdClass, <span class="string">"fd"</span>, <span class="string">"I"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Java_java_io_FileDescriptor_initIDs</code>对应<code>FileDescriptor</code>中static块调用的<code>initIDs</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDescriptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        initIDs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This routine initializes JNI field offsets for the class */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">initIDs</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码可以看出这样的一个流程：</p>
<ol>
<li>JVM加载FileDescriptor类，执行static块中的代码</li>
<li>执行static块中的代码时，执行initIDs本地方法</li>
<li>initIDs本地方法只做了一件事情，就是获取fd字段ID，并保存在IO_fd_fdID变量中</li>
<li>JVM加载FileInputStream类，执行static块中的代码</li>
<li>执行static块中的代码时，执行initIDs本地方法</li>
<li>initIDs本地方法只做了一件事情，就是获取fd字段ID，并保存在fis_fd变量中</li>
<li>后续逻辑直接使用IO_fd_fdID和fis_fd</li>
</ol>
<p>为什么会有这样一个奇怪的初始化过程呢，为什么要专门弄一个initIDs方法来提前保存字段ID呢？这是因为特定类的字段ID在一次Java程序的声明周期中是不会变化的，而获取字段ID本身是一个比较耗时的过程，因为如果字段是从父类继承而来，JVM需要遍历继承树来找到这个字段，所以JNI代码的最佳实践就是对使用到的字段ID做缓存。（参考<a href="http://www.ibm.com/developerworks/cn/java/j-jni/index.html" target="_blank" rel="noopener">使用 Java Native Interface 的最佳实践</a>）</p>
<h2 id="标准输入，标准输出，标准错误输出"><a href="#标准输入，标准输出，标准错误输出" class="headerlink" title="标准输入，标准输出，标准错误输出"></a>标准输入，标准输出，标准错误输出</h2><p>标准输入，标准输出，标准错误输出是所有操作系统都支持的，对于一个进程来说，文件描述符0,1,2固定是标准输入，标准输出，标准错误输出。</p>
<p>Java对标准输入，标准输出，标准错误输出的支持也是通过FileDescriptor实现的，<code>FileDescriptor</code>中定义了in，out，err这三个静态变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> FileDescriptor in = <span class="keyword">new</span> FileDescriptor(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> FileDescriptor out = <span class="keyword">new</span> FileDescriptor(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> FileDescriptor err = <span class="keyword">new</span> FileDescriptor(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>我们常用的<code>System.out</code>等，就是基于这三个封装的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">System</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> PrintStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> PrintStream err = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initialize the system class.  Called after thread initialization.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeSystemClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FileInputStream fdIn = <span class="keyword">new</span> FileInputStream(FileDescriptor.in);</span><br><span class="line">        FileOutputStream fdOut = <span class="keyword">new</span> FileOutputStream(FileDescriptor.out);</span><br><span class="line">        FileOutputStream fdErr = <span class="keyword">new</span> FileOutputStream(FileDescriptor.err);</span><br><span class="line">        setIn0(<span class="keyword">new</span> BufferedInputStream(fdIn));</span><br><span class="line">        setOut0(newPrintStream(fdOut, props.getProperty(<span class="string">"sun.stdout.encoding"</span>)));</span><br><span class="line">        setErr0(newPrintStream(fdErr, props.getProperty(<span class="string">"sun.stderr.encoding"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setIn0</span><span class="params">(InputStream in)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setOut0</span><span class="params">(PrintStream out)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setErr0</span><span class="params">(PrintStream err)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>System作为一个特殊的类，类构造时无法实例化<code>in/out/err</code>，构造发生在<code>initializeSystemClass</code>被调用时，但是<code>in/out/err</code>是被声明为final的，如果声明时和类构造时没有赋值，是会报错的，所以System在实现时，先设置为null，然后通过native方法来在运行时修改（学到了不少奇技淫巧。。），通过<code>setIn0/setOut0/setErr0</code>的注释也可以说明这一点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following three functions implement setter methods for</span></span><br><span class="line"><span class="comment"> * java.lang.System.&#123;in, out, err&#125;. They are natively implemented</span></span><br><span class="line"><span class="comment"> * because they violate the semantics of the language (i.e. set final</span></span><br><span class="line"><span class="comment"> * variable).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_lang_System_setIn0(JNIEnv *env, jclass cla, jobject stream)</span><br><span class="line">&#123;</span><br><span class="line">    jfieldID fid =</span><br><span class="line">        (*env)-&gt;GetStaticFieldID(env,cla,<span class="string">"in"</span>,<span class="string">"Ljava/io/InputStream;"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    (*env)-&gt;SetStaticObjectField(env,cla,fid,stream);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_lang_System_setOut0(JNIEnv *env, jclass cla, jobject stream)</span><br><span class="line">&#123;</span><br><span class="line">    jfieldID fid =</span><br><span class="line">        (*env)-&gt;GetStaticFieldID(env,cla,<span class="string">"out"</span>,<span class="string">"Ljava/io/PrintStream;"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    (*env)-&gt;SetStaticObjectField(env,cla,fid,stream);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_lang_System_setErr0(JNIEnv *env, jclass cla, jobject stream)</span><br><span class="line">&#123;</span><br><span class="line">    jfieldID fid =</span><br><span class="line">        (*env)-&gt;GetStaticFieldID(env,cla,<span class="string">"err"</span>,<span class="string">"Ljava/io/PrintStream;"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    (*env)-&gt;SetStaticObjectField(env,cla,fid,stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="FileDescriptor关闭逻辑"><a href="#FileDescriptor关闭逻辑" class="headerlink" title="FileDescriptor关闭逻辑"></a>FileDescriptor关闭逻辑</h2><p><code>FileDescriptor</code>的代码不多，除了上面提到的<code>fd</code>成员变量，<code>initIDs</code>初始化构造方法，<code>in/out/err</code>三个标准描述符，只剩下<code>attach</code>和<code>closeAll</code>这两个方法，这两个方法和文件描述符的关闭有关。</p>
<p>上文提到过，<code>FileInputStream</code>在实例化时，会新建<code>FileDescriptor</code>并调用<code>FileDescriptor#attach</code>方法绑定文件流与文件描述符。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileInputStream</span><span class="params">(File file)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">    String name = (file != <span class="keyword">null</span> ? file.getPath() : <span class="keyword">null</span>);</span><br><span class="line">    fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">    fd.attach(<span class="keyword">this</span>);</span><br><span class="line">    path = name;</span><br><span class="line">    open(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FileDescriptor#attach</code>实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Closeable c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// first caller gets to do this</span></span><br><span class="line">        parent = c;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (otherParents == <span class="keyword">null</span>) &#123;</span><br><span class="line">        otherParents = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        otherParents.add(parent);</span><br><span class="line">        otherParents.add(c);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        otherParents.add(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>FileDescriptor</code>只和一个<code>FileInputStream/FileOutputStream/RandomAccessFile</code>有关联，则只是简单的保存到<code>parent</code>成员中，如果有多个<code>FileInputStream/FileOutputStream/RandomAccessFile</code>有关联，则所有关联的<code>Closeable</code>都保存到<code>otherParents</code>这个<code>ArrayList</code>中。</p>
<p>这里其实有个细节，就是<code>parent</code>变量其实只在这个函数有用到，所以上面的逻辑完全可以写成无论<code>FileDescriptor</code>和几个<code>Closeable</code>对象有关联，都直接保存到<code>otherParents</code>这个<code>ArrayList</code>即可，但是极大的概率，一个<code>FileDescriptor</code>只会和一个<code>FileInputStream/FileOutputStream/RandomAccessFile</code>有关联，只有用户调用<code>FileInputStream(FileDescriptor fdObj)</code>这样样的构造函数才会出现多个<code>Closeable</code>对象对应一个<code>FileDescriptor</code>的情况，这里其实是做了优化，在大概率的情况下不新建<code>ArrayList</code>，减少一个对象的创建开销。</p>
<p>接着看看<code>FileInputStream</code>如何进行关闭操作，如何关闭关联的<code>FileDescriptor</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (closeLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        closed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</span><br><span class="line">        channel.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd.closeAll(<span class="keyword">new</span> Closeable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            close0();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">close0</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>首先通过锁保证关闭流程不会被并发调用，设置成员<code>closed</code>为<code>true</code>，接着关闭关联的Channel，这个以后分析NIO的时候再来说。接着就是关闭<code>FileDescriptor</code>了。</p>
<p><code>FileDescriptor</code>没有提供<code>close</code>方法，而是提供了一个<code>closeAll</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">closeAll</span><span class="params">(Closeable releaser)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!closed) &#123;</span><br><span class="line">        closed = <span class="keyword">true</span>;</span><br><span class="line">        IOException ioe = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> (Closeable c = releaser) &#123;</span><br><span class="line">            <span class="keyword">if</span> (otherParents != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Closeable referent : otherParents) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        referent.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span>(IOException x) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ioe == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            ioe = x;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            ioe.addSuppressed(x);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException ex) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * If releaser close() throws IOException</span></span><br><span class="line"><span class="comment">             * add other exceptions as suppressed.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (ioe != <span class="keyword">null</span>)</span><br><span class="line">                ex.addSuppressed(ioe);</span><br><span class="line">            ioe = ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ioe != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> ioe;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FileDescriptor</code>的关闭流程有点绕，效果是会把关联的<code>Closeable</code>对象（其实只可能是<code>FileInputStream/FileOutputStream/RandomAccessFile</code>，而这三个类的<code>close</code>方法实现是一模一样的）通通都关闭掉（效果是这些对象的<code>closed</code>设置为true，关联的Channel关闭，这样这个对象就无法使用了），最后这些关联的对象中，只会有一个对象的<code>close0</code>本地方法被调用，这个方法中调用系统调用<code>close</code>来真正关闭文件描述符：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /jdk/src/solaris/native/java/io/FileInputStream_md.c</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileInputStream_close0(JNIEnv *env, jobject <span class="keyword">this</span>) &#123;</span><br><span class="line">    fileClose(env, <span class="keyword">this</span>, fis_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /jdk/src/solaris/native/java/io/io_util_md.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fileClose</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>, jfieldID fid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the fd to -1 before closing it so that the timing window</span></span><br><span class="line"><span class="comment">     * of other threads using the wrong fd (closed but recycled fd,</span></span><br><span class="line"><span class="comment">     * that gets re-opened with some other filename) is reduced.</span></span><br><span class="line"><span class="comment">     * Practically the chance of its occurance is low, however, we are</span></span><br><span class="line"><span class="comment">     * taking extra precaution over here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SET_FD(<span class="keyword">this</span>, <span class="number">-1</span>, fid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试关闭0，1，2文件描述符，需要特殊的操作。首先这三个是不能关闭的，</span></span><br><span class="line">    <span class="comment">// 如果关闭的，后续打开的文件就会占用这三个描述符，</span></span><br><span class="line">    <span class="comment">// 所以合理的做法是把要关闭的描述符指向/dev/null，实现关闭的效果</span></span><br><span class="line">    <span class="comment">// 不过Java代码中，正常是没办法关闭0，1，2文件描述符的</span></span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= STDIN_FILENO &amp;&amp; fd &lt;= STDERR_FILENO) &#123;</span><br><span class="line">        <span class="keyword">int</span> devnull = open(<span class="string">"/dev/null"</span>, O_WRONLY);</span><br><span class="line">        <span class="keyword">if</span> (devnull &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            SET_FD(<span class="keyword">this</span>, fd, fid); <span class="comment">// restore fd</span></span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, <span class="string">"open /dev/null failed"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dup2(devnull, fd);</span><br><span class="line">            close(devnull);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (close(fd) == <span class="number">-1</span>) &#123; <span class="comment">// 关闭非0，1，2的文件描述符只是调用close系统调用</span></span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"close failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在回头来讨论一个问题，就是为什么关闭一个<code>FileInputStream/FileOutputStream/RandomAccessFile</code>，就要把他关联的文件描述符所关联的所有<code>FileInputStream/FileOutputStream/RandomAccessFile</code>对象都关闭呢？</p>
<p>这个可以看看<code>FileInputStream#close</code>的JavaDoc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Closes this file input stream and releases any system resources</span><br><span class="line">associated with the stream.</span><br><span class="line"></span><br><span class="line">If this stream has an associated channel then the channel is closed</span><br><span class="line">as well.</span><br></pre></td></tr></table></figure>
<p>也就是说<code>FileInputStream#close</code>是会吧输入/出流对应的系统资源关闭的，也就是输入/出流对应的文件描述符会被关闭，而如果这个文件描述符还关联这其他输入/出流，如果文件描述符都被关闭了，这些流自然也就不能用了，所以closeAll里把这些关联的流通通都关闭掉，使其不再可用。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><code>FileDescriptor</code>的作用是保存操作系统中的文件描述符</li>
<li><code>FileDescriptor</code>实例会被<code>FileInputStream/FileOutputStream/RandomAccessFile</code>持有，这三个类在打开文件时，在JNI代码中使用<code>open</code>系统调用打开文件，得到文件描述符在JNI代码中设置到<code>FileDescriptor</code>的<code>fd</code>成员变量上</li>
<li>关闭<code>FileInputStream/FileOutputStream/RandomAccessFile</code>时，会关闭底层对应的文件描述符，如果此文件描述符被多个<code>FileInputStream/FileOutputStream/RandomAccessFile</code>对象持有，则这些对象都会被关闭。关闭是文件底层是通过调用<code>close</code>系统调用实现的。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>《UNIX环境高级编程》</li>
<li><a href="https://blog.csdn.net/cywosp/article/details/38965239" target="_blank" rel="noopener">每天进步一点点——Linux中的文件描述符与打开文件之间的关系 - CSDN博客</a></li>
<li><a href="https://blog.csdn.net/qq_29350001/article/details/65437279" target="_blank" rel="noopener">UNIX再学习 – 文件描述符 - CSDN博客</a></li>
<li><a href="https://www.cnblogs.com/bakari/p/5520860.html" target="_blank" rel="noopener">Linux探秘之用户态与内核态 - aCloudDeveloper - 博客园</a></li>
<li><a href="https://www.cnblogs.com/sfireworks/p/4428972.html" target="_blank" rel="noopener">关于内核态和用户态切换开销的测试 - fireworks - 博客园</a></li>
<li><a href="https://www.zhihu.com/question/32043825" target="_blank" rel="noopener">系统调用真正的效率瓶颈在哪里？ - 知乎</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/java/j-jni/index.html" target="_blank" rel="noopener">使用 Java Native Interface 的最佳实践</a></li>
<li><a href="https://stackoverflow.com/questions/34980241/why-closing-an-input-stream-closes-the-associated-file-descriptor-as-well-even" target="_blank" rel="noopener">java - Why closing an Input Stream closes the associated File Descriptor as well, even the File Descriptor is shared among multiple streams ? - Stack Overflow</a></li>
</ul>
</div><div class="reward"><hr><div class="text">如果觉得文章对你有帮助，就打赏杯咖啡钱呗😊</div><img src="/img/reward/weixin.png"><img src="/img/reward/alipay.png"></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://mushanshitiancai.github.io/2018/05/29/java/language/JDK源码阅读-FileDescriptor/" data-id="cjkju3f0a00ehlg31p42fgld0" class="article-share-link">分享</a><div class="tags"><a href="/tags/java/">java</a></div><div class="post-nav"><a href="/2018/06/03/java/language/JDK源码阅读-FileInputStream/" class="pre">JDK源码阅读-FileInputStream</a><a href="/2018/05/28/java/debug/JVM堆内存使用率持续上升的一种排查思路/" class="next">JVM堆内存使用率持续上升的一种排查思路</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'mushan';
var disqus_identifier = '2018/05/29/java/language/JDK源码阅读-FileDescriptor/';
var disqus_title = 'JDK源码阅读-FileDescriptor';
var disqus_url = 'http://mushanshitiancai.github.io/2018/05/29/java/language/JDK源码阅读-FileDescriptor/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//mushan.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://mushanshitiancai.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Groovy/">Groovy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JDK源码阅读/">JDK源码阅读</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/掌握Java/">掌握Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/调试/">调试</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/TypeScript/">TypeScript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/electron/">electron</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/自动化/">自动化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/自己动手写操作系统/">自己动手写操作系统</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/bochs/" style="font-size: 15px;">bochs</a> <a href="/tags/work/" style="font-size: 15px;">work</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/db/" style="font-size: 15px;">db</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/angularjs/" style="font-size: 15px;">angularjs</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/mmnote/" style="font-size: 15px;">mmnote</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/protocol-buffers/" style="font-size: 15px;">protocol-buffers</a> <a href="/tags/mq/" style="font-size: 15px;">mq</a> <a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/emacs/" style="font-size: 15px;">emacs</a> <a href="/tags/管理后台/" style="font-size: 15px;">管理后台</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/os/" style="font-size: 15px;">os</a> <a href="/tags/vagrant/" style="font-size: 15px;">vagrant</a> <a href="/tags/tmux/" style="font-size: 15px;">tmux</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/automation/" style="font-size: 15px;">automation</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/project/" style="font-size: 15px;">project</a> <a href="/tags/test/" style="font-size: 15px;">test</a> <a href="/tags/software/" style="font-size: 15px;">software</a> <a href="/tags/ffmpeg/" style="font-size: 15px;">ffmpeg</a> <a href="/tags/gm/" style="font-size: 15px;">gm</a> <a href="/tags/graphicsmagick/" style="font-size: 15px;">graphicsmagick</a> <a href="/tags/wireshark/" style="font-size: 15px;">wireshark</a> <a href="/tags/vscode/" style="font-size: 15px;">vscode</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/curl/" style="font-size: 15px;">curl</a> <a href="/tags/javafx/" style="font-size: 15px;">javafx</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/junit/" style="font-size: 15px;">junit</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/groovy/" style="font-size: 15px;">groovy</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/doclet/" style="font-size: 15px;">doclet</a> <a href="/tags/log4j/" style="font-size: 15px;">log4j</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/jquery/" style="font-size: 15px;">jquery</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/typescript/" style="font-size: 15px;">typescript</a> <a href="/tags/ts/" style="font-size: 15px;">ts</a> <a href="/tags/gulp/" style="font-size: 15px;">gulp</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/07/java/language/JDK源码阅读-ByteBuffer/">JDK源码阅读-ByteBuffer</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/01/java/language/JDK源码阅读-InterruptibleChannel与可中断IO/">JDK源码阅读-InterruptibleChannel与可中断IO</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/28/java/language/Java日志-Log4j实现运行时修改日志级别/">Java日志-Log4j实现运行时修改日志级别</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/28/java/language/Java日志-Log4j源码分析/">Java日志-Log4j源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/22/java/language/Java日志-SLF4J使用与源码分析/">Java日志-SLF4J使用与源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/11/os/自己动手写操作系统-计算机通电之后的操作/">自己动手写操作系统-计算机通电之后的操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/11/os/Bochs学习-安装配置篇/">Bochs学习-安装配置篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/18/java/language/Java如何保证文件落盘？/">Java如何保证文件落盘？</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/17/linux/Linux-UNIX编程如何保证文件落盘/">Linux/UNIX编程如何保证文件落盘</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/07/db/MongoDB遍历方式对比/">MongoDB遍历方式对比</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//mushan.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://anotom.com/" title="鑫哥的博客" target="_blank">鑫哥的博客</a><ul></ul><a href="https://www.caylor.cc/" title="乐哥的博客" target="_blank">乐哥的博客</a><ul></ul><a href="http://zach41.github.io/" title="小美的博客" target="_blank">小美的博客</a><ul></ul><a href="http://blog.csdn.net/sinat_25127047" title="瀚文的博客" target="_blank">瀚文的博客</a><ul></ul><a href="http://blog.csdn.net/xiaohangblog?viewmode=contents)" title="小杭的博客" target="_blank">小杭的博客</a><ul></ul><a href="http://bettercuicui.github.io/" title="夏侯的博客" target="_blank">夏侯的博客</a><ul></ul><a href="http://damye.github.io/" title="符尧的博客" target="_blank">符尧的博客</a><ul></ul><a href="http://blog.shrp.me/" title="尚弟的博客" target="_blank">尚弟的博客</a><ul></ul><a href="http://imethan.cn" title="应锋的博客" target="_blank">应锋的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">木杉的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>