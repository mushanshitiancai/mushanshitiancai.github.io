<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这是木杉的个人博客"><title>IndexedDB笔记-基本使用 | 木杉的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ec7ecb4616a008addeb60c9709230453";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">IndexedDB笔记-基本使用</h1><a id="logo" href="/.">木杉的博客</a><p class="description">要么精通，要么死</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">IndexedDB笔记-基本使用</h1><div class="post-meta">Feb 27, 2018<span> | </span><span class="category"><a href="/categories/JavaScript/">JavaScript</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="2018/02/27/js/javascript/IndexedDB笔记-基本使用/" href="/2018/02/27/js/javascript/IndexedDB笔记-基本使用/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#打开数据库（database）"><span class="toc-number">1.</span> <span class="toc-text">打开数据库（database）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库版本"><span class="toc-number">1.1.</span> <span class="toc-text">数据库版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Object-Store"><span class="toc-number">2.</span> <span class="toc-text">Object Store</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务"><span class="toc-number">3.</span> <span class="toc-text">事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加数据"><span class="toc-number">4.</span> <span class="toc-text">添加数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#删除数据"><span class="toc-number">5.</span> <span class="toc-text">删除数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新数据"><span class="toc-number">6.</span> <span class="toc-text">更新数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#统计数据数量"><span class="toc-number">7.</span> <span class="toc-text">统计数据数量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询数据"><span class="toc-number">8.</span> <span class="toc-text">查询数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Range"><span class="toc-number">9.</span> <span class="toc-text">Key Range</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Cursor查询数据"><span class="toc-number">10.</span> <span class="toc-text">使用Cursor查询数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引查询"><span class="toc-number">11.</span> <span class="toc-text">索引查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">12.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="post-content"><p>Web Application，网页应用是大势所趋，网页如果要提供本地应用级别的体验，存储是不可缺少的功能。从最早的Cookie，到LocalStorage，到IndexedDB，前端存储方案从简单的键值对到现在的数据库，功能不断强大。</p>
<p>IndexedDB是一种可以让你在用户的浏览器内持久化存储数据的方法。IndexedDB为生成Web Application提供了丰富的查询能力，使我们的应用在在线和离线时都可以正常工作。IndexedDB是一个功能完备的NoSQL数据库。</p>
<a id="more"></a>
<p>提示：IndexedDB提供的API是底层API，加上IndexedDB异步的设计，在使用上可能会比较麻烦，可以使用第三方对于IndexedDB API的封装库来简化代码，减少痛苦，比如<a href="https://localforage.github.io/localForage/" target="_blank" rel="noopener">localForage</a>，<a href="http://www.dexie.org/" target="_blank" rel="noopener">dexie.js</a>，<a href="https://github.com/erikolson186/zangodb" target="_blank" rel="noopener">ZangoDB</a>，<a href="http://jsstore.net/" target="_blank" rel="noopener">JsStore</a>等。</p>
<h2 id="打开数据库（database）"><a href="#打开数据库（database）" class="headerlink" title="打开数据库（database）"></a>打开数据库（database）</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request = indexedDB.open(<span class="string">"TestDB"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">request.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 打开数据库失败</span></span><br><span class="line">&#125;</span><br><span class="line">request.onsuccess = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 打开数据库成功，成功后request.result会被设置为db对象</span></span><br><span class="line">    <span class="keyword">let</span> db = request.result；</span><br><span class="line">&#125;</span><br><span class="line">request.onupgradeneeded = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 在数据库版本升级时触发</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从打开数据库和后端的编程体验就不一样了。首先IndexDB的所有操作都是异步的，打开数据库也不例外。</p>
<p><code>open</code>函数打开一个数据库连接，第一个参数指定数据库名称，第二个是一个可选参数，指定数据库的版本，如果不指定，则看数据库是否已经存在，如果已经存在，则打开数据库并且不更新版本，如果数据库不存在，则创建该数据库并且版本为1。</p>
<p><code>open</code>函数会立刻返回一个<code>IDBOpenDBRequest</code>对象，但是这会儿数据库还没打开好。如果数据库打开成功，则触发<code>success</code>事件，并设置Request对象的<code>result</code>字段为<code>IDBDatabase</code>实例。然后我们就可以用db实例来进行数据库操作了。</p>
<h3 id="数据库版本"><a href="#数据库版本" class="headerlink" title="数据库版本"></a>数据库版本</h3><p>数据库的版本也是令人疑惑的一个地方，之前接触的后端数据库都没有版本的概念。一般我们在使用SQL数据库的时候，在应用开始使用数据库前，我们要执行建库建表语句，然后应用才能正常的使用数据库。而在开发的过程中，如果需要升级数据表的结构，我们需要通知DBA在夜深人静的时候执行更新数据表结构的语句。</p>
<p>对于后端开发，我们可以专门的有人有时间去维护数据库结构，而对于浏览器端则不一样了，你的代码在客户端建立了一个数据表，之后需要更新结构，是不会有专人去更新的，还是得你的JS代码来更新。那如何知这个用户的浏览器中的数据表需要更新了呢？一种方法就是程序根据当前需要来检测浏览器中的表结构，索引是否符合当前需求，但是随着程序的不断维护，这个检测代码会越发的复杂，所以IndexedDB设计上就考虑了这个场景，为数据库的结构定义版本，如果需要修改数据表结构，就增加版本。IndexedDB检测当前版本和客户端的版本是否一致，如果客户端的版本低于当前需要的版本，则触发<code>upgradeneeded</code>事件，让用户有机会去执行升级数据表结构的代码。</p>
<p>所以<code>onupgradeneeded</code>回调函数会在<code>open</code>一个大于浏览器中现存版本的数据库时触发，也只有在这个函数中可以更新对象存储空间和索引。</p>
<h2 id="Object-Store"><a href="#Object-Store" class="headerlink" title="Object Store"></a>Object Store</h2><p>SQL数据库使用表来存储记录，IndexedDB中没有表，而是使用object store（对象存储空间）来存储记录。每条记录需要和一个键相关联。</p>
<p>可以指定记录中的一个字段作为键值（key path），或者可以使用自动生成的递增数字作为键值（key generate）。</p>
<table>
<thead>
<tr>
<th>Key Path</th>
<th>Key Generator</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>No</td>
<td>No</td>
<td>这个存储对象空间可以放任何类型的值（原始类型，对象），但是需要指定一个单独的Key与值进行关联</td>
</tr>
<tr>
<td>Yes</td>
<td>No</td>
<td>这个存储对象空间只能存放对象，这个对象必须有一个和KeyPath同名的属性</td>
</tr>
<tr>
<td>No</td>
<td>Yes</td>
<td>这个存储对象空间可以放任何类型的值（原始类型，对象），与值关联的Key会自动生成，如果你要指定，也是可以的</td>
</tr>
<tr>
<td>Yes</td>
<td>Yes</td>
<td>这个存储对象空间只能存放对象，这个对象必须有一个和KeyPath同名的属性，这个属性值会自动生成，但是如果属性值存在，则会使用属性值</td>
</tr>
</tbody>
</table>
<p>看着这两个的定义还是有点复杂的。我们可以联系SQL数据库来思考。SQL的表结构包含多个字段，必须有一个主键。主键可以设置为自增或者是自定义。IndexedDB只不过是存储结构有一些不同，它更加灵活，它也需要一个主键，只是这个可以是数据上的，也可以是数据外的。KeyPath为No，也就是不在数据中保存主键，所以存储对象空间可以存放任何类型，而KeyPath为Yes，则需要在数据中保存主键，所以数据也就只能是对象了。Key Generator则是指定主键是否是自增的，如果是Yes，则主键自增，但是也可以自己指定，如果为No，则主键必须用户自己指定。</p>
<p><code>key path</code>和<code>key generate</code>配置的是对象存储空间的主键和是否自增。IndexedDB还支持索引和唯一索引，前提是对象存储空间存储的是对象。</p>
<p>新建对象存储空间方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objectStore = IDBDatabase.createObjectStore(name, options);</span><br></pre></td></tr></table></figure>
<p><code>name</code>参数指定对象存储空间名称，<code>options</code>参数是可选的，可选的属性有：</p>
<ul>
<li><code>keyPath</code>： 指定主键，可以是一个数组。如果没有指定，则会使用独立的键值（out-of-line keys）作为主键</li>
<li><code>autoIncrement</code>：对应上面说的Key Generator配置，默认false</li>
</ul>
<p>新建索引方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myIDBIndex = objectStore.createIndex(indexName, keyPath, objectParameters);</span><br></pre></td></tr></table></figure>
<p><code>indexName</code>指定索引名称。<code>keyPath</code>指定索引的键，可以是一个数组。<code>objectParameters</code>参数是可选的，可选的属性有：</p>
<ul>
<li><code>unique</code>：指定索引为唯一索引</li>
<li><code>multiEntry</code>：</li>
</ul>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>IndexedDB所有操作都需要在事务上进行，而且事务都是显式的。我们通过数据库对象得到事务，然后在事务上提交操作。</p>
<p>IndexedDB事务有三种模式<code>readonly</code>，<code>readwrite</code>和<code>versionchange</code>。如果事务只有读取数据库的操作，则使用<code>readonly</code>模式，如果事务需要更新数据库需要使用<code>readwrite</code>模式。<code>versionchange</code>事务用于更新数据库结构，一般情况下我们无法获取这种模式的事务，但是在指定更高version来打开数据库时，数据库会开启此事务，并触发<code>onupgradeneeded()</code>回调，这就是为啥只能在<code>onupgradeneeded()</code>中更新数据库结构的原因。</p>
<p>开启事务：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> IDBTransaction = IDBDatabase.transaction(storeNames, mode);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>storeNames</code> object store名称数组，用于指定事务操作覆盖的object store</li>
<li><code>mode</code> 事务模式，可选值为<code>readonly</code>，<code>readwrite</code>，默认值为<code>readonly</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该事务需要操作'my-store-name'和'my-store-name2'这两个对象存储空间</span></span><br><span class="line"><span class="keyword">var</span> transaction = db.transaction([<span class="string">'my-store-name'</span>, <span class="string">'my-store-name2'</span>]); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 该事物只操作my-store-name这个对象存储空间，可以直接用字符串</span></span><br><span class="line"><span class="keyword">var</span> transaction = db.transaction(<span class="string">'my-store-name'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该事物需要操作所有的对象存储空间</span></span><br><span class="line"><span class="keyword">var</span> transaction = db.transaction(db.objectStoreNames);</span><br></pre></td></tr></table></figure>
<p>个人观点是，事务在声明时就需要指定模式和之后操作涉及的对象存储空间，其实是比较麻烦的，为什么这么做，应该是为了更容易的优化性能。指定操作的模式，那对于自读模式，可以不用加锁的并发，对于读写模式，则可能需要加锁。同时指定了操作的object store，则可以确定要对那些object store（以上属于推测）。</p>
<p>事务能接收三中DOM事件：<code>error</code>, <code>abort</code>, <code>complete</code>。在事务中提交的操作发生的错误都会冒泡到事务（然后冒泡到db实例）。在事务发生错误时，事务会回滚，除非你在错误处理函数中调用<code>preventDefault()</code>。如果你没有处理错误或者调用了事务的<code>abort()</code>方法，则事务回滚，并触发<code>abort</code>事件。如果事务成功，触发<code>complete</code>事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> transaction = db.transaction(<span class="string">"user"</span>, <span class="string">"readwrite"</span>);</span><br><span class="line">transaction.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 事务失败时触发</span></span><br><span class="line">&#125;;</span><br><span class="line">transaction.oncomplete = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 事务成功结束时触发</span></span><br><span class="line">&#125;;</span><br><span class="line">transaction.onabort = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 事务回滚时触发</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>事务声明好了后，我们通过事务获取object storage，然后就可以对object storage进行操作了。获取<a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore" target="_blank" rel="noopener">IDBObjectStore</a>对象的方法如下，注意，这里只能获取在新建transaction时指定的object storage数组中的object storage：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDBObjectStore objectStore = IDBTransaction.objectStore(name);</span><br></pre></td></tr></table></figure>
<h2 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDBRequest request = objectStore.add(value);</span><br><span class="line">IDBRequest request = objectStore.add(value, key);</span><br></pre></td></tr></table></figure>
<p>拿到<code>IDBRequest</code>对象，可以通过<code>onerror</code>和<code>onsuccess</code>两个回调来监听操作是否成功或者失败。</p>
<p>如果object store没有使用key path，则需要指定数据的键，即使用<code>objectStore.add(value, key)</code>方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> objectStore = transaction.objectStore(<span class="string">"user"</span>);</span><br><span class="line"><span class="keyword">let</span> r = objectStore.add(&#123;...&#125;, <span class="string">"name"</span>);</span><br><span class="line">r.onsuccess = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'add request success'</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">r.onerror = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'add request error'</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IDBRequest request = objectStore.delete(Key);</span><br><span class="line">IDBRequest request = objectStore.delete(KeyRange);</span><br><span class="line"></span><br><span class="line">IDBRequest request = objectStore.clear();</span><br></pre></td></tr></table></figure>
<h2 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDBRequest request = objectStore.put(item);</span><br><span class="line">IDBRequest request = objectStore.put(item, key);</span><br></pre></td></tr></table></figure>
<h2 id="统计数据数量"><a href="#统计数据数量" class="headerlink" title="统计数据数量"></a>统计数据数量</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDBRequest request = ObjectStore.count();</span><br><span class="line">IDBRequest request = ObjectStore.count(query);</span><br></pre></td></tr></table></figure>
<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDBRequest request = objectStore.get(key);</span><br><span class="line">IDBRequest request = objectStore.getKey(key);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request = db.transaction(<span class="string">"user"</span>)</span><br><span class="line">    .objectStore(<span class="string">"user"</span>)</span><br><span class="line">    .get(<span class="string">"mushan"</span>);</span><br><span class="line">request.onsuccess = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(request.result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为传入的event对象的target属性会被设置为对应的request，所以还可以进一步简化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.transaction(<span class="string">"user"</span>)</span><br><span class="line">    .objectStore(<span class="string">"user"</span>)</span><br><span class="line">    .get(<span class="string">"mushan"</span>);</span><br><span class="line">    .onsuccess = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(request.result);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Key-Range"><a href="#Key-Range" class="headerlink" title="Key Range"></a>Key Range</h2><p>IndexedDB除了对一个特定值进行查找，可以针对一个范围进行查找，使用到IDBKeyRange：</p>
<table>
<thead>
<tr>
<th>Range</th>
<th>Code</th>
</tr>
</thead>
<tbody>
<tr>
<td>All keys ≤ x</td>
<td>IDBKeyRange.upperBound(x)</td>
</tr>
<tr>
<td>All keys &lt; x</td>
<td>IDBKeyRange.upperBound(x, true)</td>
</tr>
<tr>
<td>All keys ≥ y</td>
<td>IDBKeyRange.lowerBound(y)</td>
</tr>
<tr>
<td>All keys &gt; y</td>
<td>IDBKeyRange.lowerBound(y, true)</td>
</tr>
<tr>
<td>All keys ≥ x &amp;&amp; ≤ y</td>
<td>IDBKeyRange.bound(x, y)</td>
</tr>
<tr>
<td>All keys &gt; x &amp;&amp;&lt; y</td>
<td>IDBKeyRange.bound(x, y, true, true)</td>
</tr>
<tr>
<td>All keys &gt; x &amp;&amp; ≤ y</td>
<td>IDBKeyRange.bound(x, y, true, false)</td>
</tr>
<tr>
<td>All keys ≥ x &amp;&amp;&lt; y</td>
<td>IDBKeyRange.bound(x, y, false, true)</td>
</tr>
<tr>
<td>The key = z</td>
<td>IDBKeyRange.only(z)</td>
</tr>
</tbody>
</table>
<h2 id="使用Cursor查询数据"><a href="#使用Cursor查询数据" class="headerlink" title="使用Cursor查询数据"></a>使用Cursor查询数据</h2><p>使用<code>get</code>方法只能获取到特定键对应的数据，如果要查询一个区间内的所有键对应的值，则需要使用Cursor对象来遍历。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IDBRequest request = ObjectStore.openCursor();</span><br><span class="line">IDBRequest request = ObjectStore.openCursor(query);</span><br><span class="line">IDBRequest request = ObjectStore.openCursor(query, direction);</span><br><span class="line"></span><br><span class="line">IDBRequest request = objectStore.openKeyCursor();</span><br><span class="line">IDBRequest request = objectStore.openKeyCursor(query);</span><br><span class="line">IDBRequest request = objectStore.openKeyCursor(query, direction);</span><br></pre></td></tr></table></figure>
<p><code>query</code>可以是key或者key range。</p>
<p><code>direction</code>的取值有：”next”, “nextunique”, “prev”, “prevunique”。默认为 “next”，即正向遍历。”prev”为反向遍历。”nextunique”表示正向遍历，同时对于一个key有多个值的情况，只会获取第一个出现的值。”prevunique”同理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.transaction(objectStoreName).objectStore(objectStoreName).openCursor().onsuccess = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cursor = e.target.result;</span><br><span class="line">    <span class="keyword">if</span> (cursor) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(cursor.key, cursor.value);</span><br><span class="line">        cursor.continue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>所以用IndexedDB遍历数据还是非常麻烦的，把结果放入一个数组中可以这么写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> customers = [];</span><br><span class="line"></span><br><span class="line">objectStore.openCursor().onsuccess = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cursor = event.target.result;</span><br><span class="line">  <span class="keyword">if</span> (cursor) &#123;</span><br><span class="line">    customers.push(cursor.value);</span><br><span class="line">    cursor.continue();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    alert(<span class="string">"Got all customers: "</span> + customers);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="索引查询"><a href="#索引查询" class="headerlink" title="索引查询"></a>索引查询</h2><p>IndexedDB除了支持主键搜索还支持索引搜索，使用<code>objectStore.index(name)</code>获得<code>IDBIndex</code>对象，就可以在索引上进行查找搜索操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDBIndex index = objectStore.index(name);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IDBIndex.count()</span><br><span class="line">IDBIndex.get()</span><br><span class="line">IDBIndex.getKey()</span><br><span class="line">IDBIndex.getAll()</span><br><span class="line">IDBIndex.getAllKeys()</span><br><span class="line">IDBIndex.openCursor()</span><br><span class="line">IDBIndex.openKeyCursor()</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Using_IndexedDB" target="_blank" rel="noopener">使用 IndexedDB - Web API 接口 | MDN</a></li>
</ul>
</div><div class="reward"><hr><div class="text">如果觉得文章对你有帮助，就打赏杯咖啡钱呗😊</div><img src="/img/reward/weixin.png"><img src="/img/reward/alipay.png"></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://mushanshitiancai.github.io/2018/02/27/js/javascript/IndexedDB笔记-基本使用/" data-id="cjk9t3j8f00jjgd31dbrexfsg" class="article-share-link">分享</a><div class="tags"><a href="/tags/js/">js</a><a href="/tags/javascript/">javascript</a></div><div class="post-nav"><a href="/2018/03/23/network/URI-URL与URN的区别/" class="pre">URI,URL与URN的区别</a><a href="/2018/02/27/tools/curl笔记-基本使用/" class="next">CURL笔记-基本使用</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'mushan';
var disqus_identifier = '2018/02/27/js/javascript/IndexedDB笔记-基本使用/';
var disqus_title = 'IndexedDB笔记-基本使用';
var disqus_url = 'http://mushanshitiancai.github.io/2018/02/27/js/javascript/IndexedDB笔记-基本使用/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//mushan.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://mushanshitiancai.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Groovy/">Groovy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JDK源码阅读/">JDK源码阅读</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/掌握Java/">掌握Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/调试/">调试</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/TypeScript/">TypeScript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/electron/">electron</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/自动化/">自动化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/自己动手写操作系统/">自己动手写操作系统</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/work/" style="font-size: 15px;">work</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/angularjs/" style="font-size: 15px;">angularjs</a> <a href="/tags/db/" style="font-size: 15px;">db</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/mmnote/" style="font-size: 15px;">mmnote</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/protocol-buffers/" style="font-size: 15px;">protocol-buffers</a> <a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/mq/" style="font-size: 15px;">mq</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/emacs/" style="font-size: 15px;">emacs</a> <a href="/tags/管理后台/" style="font-size: 15px;">管理后台</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/vagrant/" style="font-size: 15px;">vagrant</a> <a href="/tags/tmux/" style="font-size: 15px;">tmux</a> <a href="/tags/os/" style="font-size: 15px;">os</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/automation/" style="font-size: 15px;">automation</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/bochs/" style="font-size: 15px;">bochs</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/project/" style="font-size: 15px;">project</a> <a href="/tags/software/" style="font-size: 15px;">software</a> <a href="/tags/test/" style="font-size: 15px;">test</a> <a href="/tags/ffmpeg/" style="font-size: 15px;">ffmpeg</a> <a href="/tags/gm/" style="font-size: 15px;">gm</a> <a href="/tags/graphicsmagick/" style="font-size: 15px;">graphicsmagick</a> <a href="/tags/wireshark/" style="font-size: 15px;">wireshark</a> <a href="/tags/vscode/" style="font-size: 15px;">vscode</a> <a href="/tags/curl/" style="font-size: 15px;">curl</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/javafx/" style="font-size: 15px;">javafx</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/junit/" style="font-size: 15px;">junit</a> <a href="/tags/groovy/" style="font-size: 15px;">groovy</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/doclet/" style="font-size: 15px;">doclet</a> <a href="/tags/log4j/" style="font-size: 15px;">log4j</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/jquery/" style="font-size: 15px;">jquery</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/ts/" style="font-size: 15px;">ts</a> <a href="/tags/gulp/" style="font-size: 15px;">gulp</a> <a href="/tags/typescript/" style="font-size: 15px;">typescript</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/07/28/java/language/Java日志-Log4j实现运行时修改日志级别/">Java日志-Log4j实现运行时修改日志级别</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/28/java/language/Java日志-Log4j源码分析/">Java日志-Log4j源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/22/java/language/Java日志-SLF4J使用与源码分析/">Java日志-SLF4J使用与源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/11/os/自己动手写操作系统-计算机通电之后的操作/">自己动手写操作系统-计算机通电之后的操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/11/os/Bochs学习-安装配置篇/">Bochs学习-安装配置篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/18/java/language/Java如何保证文件落盘？/">Java如何保证文件落盘？</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/17/linux/Linux-UNIX编程如何保证文件落盘/">Linux/UNIX编程如何保证文件落盘</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/07/db/MongoDB遍历方式对比/">MongoDB遍历方式对比</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/04/java/language/JDK源码阅读-RandomAccessFile/">JDK源码阅读-RandomAccessFile</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/04/java/language/JDK源码阅读-FileOutputStream/">JDK源码阅读-FileOutputStream</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//mushan.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://anotom.com/" title="鑫哥的博客" target="_blank">鑫哥的博客</a><ul></ul><a href="https://www.caylor.cc/" title="乐哥的博客" target="_blank">乐哥的博客</a><ul></ul><a href="http://zach41.github.io/" title="小美的博客" target="_blank">小美的博客</a><ul></ul><a href="http://blog.csdn.net/sinat_25127047" title="瀚文的博客" target="_blank">瀚文的博客</a><ul></ul><a href="http://blog.csdn.net/xiaohangblog?viewmode=contents)" title="小杭的博客" target="_blank">小杭的博客</a><ul></ul><a href="http://bettercuicui.github.io/" title="夏侯的博客" target="_blank">夏侯的博客</a><ul></ul><a href="http://damye.github.io/" title="符尧的博客" target="_blank">符尧的博客</a><ul></ul><a href="http://blog.shrp.me/" title="尚弟的博客" target="_blank">尚弟的博客</a><ul></ul><a href="http://imethan.cn" title="应锋的博客" target="_blank">应锋的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">木杉的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>